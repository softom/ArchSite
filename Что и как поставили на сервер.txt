1) Что сейчас стоит и работает на сервере
Домены / TLS / прокси
Caddy как единая “входная дверь” с HTTPS:
https://2vhutemas.ru → статика из /var/www/2vhutemas
https://2vhutemas.ru/api/timeline → ваш прикладной сервис timeline (reverse_proxy на 127.0.0.1:7070)
https://api.2vhutemas.ru → Supabase API через Kong (reverse_proxy на localhost:8000)
Caddyfile отформатирован/валидируется.
Supabase self-host (docker compose в /opt/2vhutemas)
Поднят набор контейнеров Supabase (как минимум):
- Postgres (supa_db)
- PostgREST (REST /rest/v1)
- GoTrue (Auth /auth/v1)
- Storage API (/storage/v1)
- Kong (/ маршрутизация API)
- (и служебные компоненты Supabase)

База наружу не открыта, доступ к Postgres для админа — через SSH-туннель.

Storage (фото)
Bucket project-images (public)
Файлы перенесены из Supabase Cloud: 21 объект
Публичные ссылки работают через ваш домен:
https://api.2vhutemas.ru/storage/v1/object/public/project-images/...
Данные (public schema)
Перенесены таблицы и данные из Supabase Cloud:
authors = 16
projects = 10
media_assets = 21
и связующие таблицы (всего 16 таблиц)
Обновили public_url в media_assets, чтобы не было ссылок на *.supabase.co.
Прикладной сервис timeline (отдельный stack)
Отдельный docker-compose в /opt/2vhutemas-services
Deno-сервис timeline слушает только localhost: 127.0.0.1:7070
Доступен извне через сайт: https://2vhutemas.ru/api/timeline?...
Сделали health-страницу health.html, которая проверяет: timeline, REST, Auth, Storage.
Инструменты
DataGrip подключён к Postgres через безопасный SSH-туннель.
Редактор объектов и прочие страницы переведены на новые URL/ключи (в процессе), CORS для supabase-js поправили.
2) Что было “не так” и почему это заняло больше дня
1) Смешение контекстов “где выполняется команда”
- SSH-туннель пытались поднять на сервере, хотя нужен на Windows.
- SQL-команды (UPDATE ...) пытались выполнить в bash.
Это давало “Permission denied / command not found” и уводило время.

2) Windows + Docker networking
- контейнер postgres:17 (для pg_dump/pg_restore) не видит 127.0.0.1 хоста → нужен host.docker.internal.
Это классическая ловушка на Windows.

3) Supabase Cloud pooler / неверные параметры / пароль
- ошибки типа Tenant or user not found и password authentication failed — из-за несостыкованных host/user и путаницы “какой пароль нужен” (DB password vs API keys).
Пока не зафиксировали рабочий способ (psql тест) — теряли время.

4) CRLF/BOM и backtick в PowerShell
- попытка передавать пароли через переменные/переносы строк ломалась → Length=0.
- в итоге перешли на --env-file, что надёжнее.

5) CORS в Kong был “почти” настроен
- supabase-js добавляет заголовки x-supabase-api-version, accept-profile, content-profile, prefer и т.п.
- они не были разрешены → браузер выдавал Failed to fetch, хотя сервер “жив”.
Это съело заметное время.

6) Кэш и “код обновили, а ответ старый”
- timeline отдавал cache-control, и плюс контейнер мог не пересобраться → казалось, что правка не сработала.

7) Образ Deno
- denoland/deno:2 не существовал → потеря времени на выяснение.
Надо фиксировать конкретную версию тега заранее.

3) Как сделать в следующий раз быстрее (процедура “в 1 проход”)
A) Сразу разделить два compose
/opt/2vhutemas — только Supabase (почти не трогаем)
/opt/2vhutemas-services — все ваши HTTP-сервисы (часто меняем)
B) Чёткий “checklist контекстов”
1) Windows:
- SSH-туннель к Postgres (ssh -N -L 5433:127.0.0.1:5432 ...)
- pg_dump/pg_restore через docker + --env-file
2) Server:
- docker compose up -d
- Caddyfile правки
3) DB:
- SQL только в DataGrip/psql

C) Миграция данных — 2 файла env + 3 команды
cloud.env и local.env
pg_dump schema-only, pg_dump data-only, pg_restore (или если схема уже есть — только data-only, но проверяем таблицы заранее)
D) CORS “по умолчанию совместимый с supabase-js”
Сразу разрешать заголовки:
- apikey, authorization, content-type,
- x-supabase-api-version, x-client-info,
- accept-profile, content-profile, prefer, range, x-upsert.

E) Всегда иметь health-страницу/endpoint с первого дня
Она мгновенно показывает: что сломалось (Auth/REST/Storage/timeline).