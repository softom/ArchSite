<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Supabase –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –í–°–ï–ô –±–∞–∑—ã</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { background: #222; color: #eee; font-family: sans-serif; padding: 40px; }
    label { display: inline-block; width:120px; }
    input[type=text] { width: 440px; }
    textarea { width: 100%; min-height: 110px; background: #191919; color: #fff; }
    button { padding: 10px 30px; font-size: 1.1em; margin: 16px 0; }
    .log { font-size: 0.97em; background: #222; margin: 1em 0 0 0; padding: 10px; border-radius: 8px; border:1px solid #333; }
    .warn { color: #f8d277; }
    .err { color: #e26666; }
    .ok { color: #6fc693; }
  </style>
</head>
<body>
  <h2>Supabase: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–π –±–∞–∑—ã</h2>
  <form id="settingsForm" onsubmit="return false;">
    <div>
      <label>üõ°Ô∏è Prod URL:</label>
      <input type="text" id="prod_url" required placeholder="https://xxxxx.supabase.co">
    </div>
    <div>
      <label>üîë Prod SVC Key:</label>
      <input type="text" id="prod_key" required placeholder="SERVICE_ROLE_KEY" autocomplete="off">
    </div>
    <div>
      <label>üõ°Ô∏è Local URL:</label>
      <input type="text" id="local_url" value="http://localhost:54321" required>
    </div>
    <div>
      <label>üîë Local SVC Key:</label>
      <input type="text" id="local_key" required placeholder="SERVICE_ROLE_KEY –ª–æ–∫–∞–ª–∫–∏" autocomplete="off">
    </div>
    <div>
      <label>–¢–∞–±–ª–∏—Ü—ã (—á–µ—Ä–µ–∑ ,):</label>
      <input type="text" id="tables" value="styles,phenomena,projects,authors,features,media_assets,reference_entries,reference_author,phenomenon_style,project_author,project_feature,project_media,project_style,style_reference">
    </div>
    <button id="btnCopy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –í–°–Å</button>
  </form>
  <div class="log" id="log">–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å.</div>
  <script>
    async function copyTables() {
      const prodUrl = document.getElementById('prod_url').value.trim();
      const prodKey = document.getElementById('prod_key').value.trim();
      const localUrl = document.getElementById('local_url').value.trim();
      const localKey = document.getElementById('local_key').value.trim();
      const tablesRaw = document.getElementById('tables').value.trim();
      const tables = tablesRaw.split(',').map(x => x.trim()).filter(Boolean);
      const logArea = document.getElementById('log');
      logArea.innerHTML = "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤‚Ä¶<br>";

      if (!prodUrl || !prodKey || !localUrl || !localKey || !tables.length) {
        logArea.innerHTML = "<span class=err>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!</span>";
        return;
      }
      try {
        const prod = supabase.createClient(prodUrl, prodKey, { auth: { persistSession: false } });
        const local = supabase.createClient(localUrl, localKey, { auth: { persistSession: false } });

        for (let table of tables) {
          logArea.innerHTML += `<br>üì• <b>${table}</b>: —á–∏—Ç–∞–µ–º‚Ä¶`;
          let { data, error } = await prod.from(table).select('*');
          if (error) {
            logArea.innerHTML += `<br><span class=warn>‚Ä£ –¢–∞–±–ª–∏—Ü–∞ "${table}": –æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: ${error.message}</span>`;
            continue;
          }
          logArea.innerHTML += ` –ü–æ–ª—É—á–µ–Ω–æ: ${data.length}. –ö–æ–ø–∏—Ä—É–µ–º‚Ä¶`;
          // –ë–∞—Ç—á-–∑–∞–≥—Ä—É–∑–∫–∞ (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)
          let total = data.length, batch = 500, index = 0;
          while (index < total) {
            const chunk = data.slice(index, index + batch);
            let { error: insertErr } = await local.from(table).upsert(chunk, { onConflict: 'id' });
            if (insertErr) {
              logArea.innerHTML += `<br><span class=err>‚Ä£ –û—à–∏–±–∫–∞ upsert –¥–ª—è "${table}": ${insertErr.message}</span>`;
              break;
            }
            index += batch;
          }
          logArea.innerHTML += `<span class=ok> OK</span>`;
        }
        logArea.innerHTML += "<br><b class=ok>–ì–æ—Ç–æ–≤–æ!</b>";
      } catch (err) {
        logArea.innerHTML += `<br><span class=err>‚Ä£ –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞: ${err.message}</span>`;
      }
    }

    document.getElementById('btnCopy').onclick = () => {
      copyTables();
      return false;
    }
  </script>
</body>
</html>